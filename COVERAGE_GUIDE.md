# Code Coverage Guide

## Overview

This project uses a dual-reporting strategy for code coverage:

1. **Filtered Coverage (Business Logic)**: Excludes infrastructure and auto-generated code - **this is the primary metric for quality gates**
2. **Unfiltered Coverage (Complete)**: Includes all code - useful for identifying untested infrastructure

## Current Coverage Metrics

### Business Logic Coverage: **96.0%** ✅
- WorkflowCore: 94.2%
- WorkflowGateway: 98.9%
- **Target: ≥90%** - Currently exceeding target

### Unfiltered Coverage: 74.9%
- Includes all infrastructure and auto-generated code
- Lower percentage is expected and acceptable

---

## Running Coverage Tests

### Step 1: Run Tests with Coverage Collection

```bash
# WorkflowCore tests
dotnet test tests/WorkflowCore.Tests --configuration Release \
  --collect:"XPlat Code Coverage" \
  --results-directory ./coverage/core

# WorkflowGateway tests
dotnet test tests/WorkflowGateway.Tests --configuration Release \
  --collect:"XPlat Code Coverage" \
  --results-directory ./coverage/gateway
```

### Step 2: Generate Filtered Coverage Report (Primary Metric)

```bash
export PATH="$PATH:/Users/darren/.dotnet/tools"

reportgenerator \
  -reports:"./coverage/core/**/coverage.cobertura.xml;./coverage/gateway/**/coverage.cobertura.xml" \
  -targetdir:./coverage/filtered/report \
  -reporttypes:"Html;TextSummary;Cobertura" \
  -classfilters:"-WorkflowCore.Data.Migrations.*;-WorkflowCore.Data.WorkflowDbContextFactory;-WorkflowCore.Services.HttpClientWrapper;-WorkflowGateway.Services.KubernetesWorkflowClient;-Program"
```

**View Results:**
```bash
# Text summary
cat ./coverage/filtered/report/Summary.txt

# HTML report
open ./coverage/filtered/report/index.html
```

### Step 3: Generate Unfiltered Report (Optional - for completeness)

```bash
reportgenerator \
  -reports:"./coverage/core/**/coverage.cobertura.xml;./coverage/gateway/**/coverage.cobertura.xml" \
  -targetdir:./coverage/combined/report \
  -reporttypes:"Html;TextSummary;Cobertura"
```

---

## What Code is Excluded?

### Build-Time Exclusions (Directory.Build.props)

The following patterns are excluded from coverage collection:

1. **EF Core Migrations** (auto-generated)
   - Pattern: `**/Migrations/**/*.cs`
   - Reason: Auto-generated by Entity Framework tools

2. **Design-Time Factories**
   - Pattern: `**/*DbContextFactory.cs`
   - Reason: Only used by EF tooling during migrations

3. **Startup Code**
   - Pattern: `**/Program.cs`
   - Reason: Requires integration tests with real infrastructure

4. **Attributed Classes**
   - Classes with `[ExcludeFromCodeCoverage]` attribute
   - Reason: Explicitly marked as non-testable in unit tests

### Report-Time Exclusions (reportgenerator -classfilters)

The following classes are filtered out of coverage reports:

1. **WorkflowCore.Data.Migrations.*** - All migration classes
2. **WorkflowCore.Data.WorkflowDbContextFactory** - EF design-time factory
3. **WorkflowCore.Services.HttpClientWrapper** - Thin wrapper (tested via integration)
4. **WorkflowGateway.Services.KubernetesWorkflowClient** - Requires real K8s cluster
5. **Program** - Startup code (tested via integration/E2E tests)

---

## Adding New Exclusions

### For Thin Wrappers or Infrastructure Code

Add the `[ExcludeFromCodeCoverage]` attribute:

```csharp
using System.Diagnostics.CodeAnalysis;

[ExcludeFromCodeCoverage]
public class MyInfrastructureClass
{
    // Code that requires integration testing or wraps external dependencies
}
```

Then update the reportgenerator command in this guide with:
```bash
-classfilters:"-WorkflowCore.Data.Migrations.*;-WorkflowCore.Data.WorkflowDbContextFactory;-WorkflowCore.Services.HttpClientWrapper;-WorkflowGateway.Services.KubernetesWorkflowClient;-Program;-Namespace.MyInfrastructureClass"
```

### For File Patterns

Add to `Directory.Build.props`:

```xml
<ExcludeByFile>
  <!-- Existing exclusions -->
  **/Migrations/**/*.cs;
  **/*DbContextFactory.cs;
  **/Program.cs;
  <!-- New pattern -->
  **/MyPattern/**/*.cs;
</ExcludeByFile>
```

---

## Quality Gates

### CI/CD Pipeline

The CI/CD pipeline should enforce:

```bash
# Run filtered coverage
reportgenerator [...] -classfilters:"[exclusions]"

# Extract coverage percentage
COVERAGE=$(grep -oP 'Line coverage: \K[0-9.]+' ./coverage/filtered/report/Summary.txt)

# Enforce minimum 90%
if (( $(echo "$COVERAGE < 90.0" | bc -l) )); then
  echo "ERROR: Coverage $COVERAGE% is below minimum 90%"
  exit 1
fi
```

### Pre-Commit Validation

Before committing changes:

1. Run filtered coverage tests
2. Verify coverage ≥ 90%
3. Check that new business logic has tests

---

## Troubleshooting

### Coverage Dropped Below 90%

1. Check which components have low coverage:
   ```bash
   grep -A 100 "WorkflowCore" ./coverage/filtered/report/Summary.txt | grep -E "^\s+\w+.*[0-9.]+%"
   ```

2. Identify untested code paths:
   - Open `./coverage/filtered/report/index.html`
   - Navigate to red/yellow highlighted files
   - Add missing unit tests

### New Infrastructure Code Counted in Coverage

1. Add `[ExcludeFromCodeCoverage]` attribute to the class
2. Update reportgenerator `-classfilters` parameter
3. Document exclusion in this guide

### Coverage Report Shows 0%

1. Verify tests ran successfully:
   ```bash
   dotnet test tests/WorkflowCore.Tests --configuration Release
   ```

2. Check coverage files exist:
   ```bash
   ls -la coverage/core/**/coverage.cobertura.xml
   ls -la coverage/gateway/**/coverage.cobertura.xml
   ```

3. Verify reportgenerator is installed:
   ```bash
   dotnet tool list --global | grep reportgenerator
   ```

---

## Best Practices

1. **Always use filtered coverage** for quality gates and reporting
2. **Document exclusions** when adding new `[ExcludeFromCodeCoverage]` attributes
3. **Test business logic at unit test level** - save integration/E2E tests for infrastructure
4. **Review unfiltered coverage periodically** to identify integration test gaps
5. **Keep exclusions minimal** - only exclude truly untestable code

---

## Files Modified

- `Directory.Build.props` - Build-time exclusion configuration
- `src/WorkflowCore/Services/HttpClientWrapper.cs` - Added `[ExcludeFromCodeCoverage]`
- `src/WorkflowCore/Data/WorkflowDbContextFactory.cs` - Added `[ExcludeFromCodeCoverage]`
- `src/WorkflowGateway/Services/KubernetesWorkflowClient.cs` - Added `[ExcludeFromCodeCoverage]`

---

## References

- [Coverlet Documentation](https://github.com/coverlet-coverage/coverlet)
- [ReportGenerator Documentation](https://github.com/danielpalme/ReportGenerator)
- [ExcludeFromCodeCoverageAttribute Docs](https://learn.microsoft.com/en-us/dotnet/api/system.diagnostics.codeanalysis.excludefromcodecoverageattribute)
