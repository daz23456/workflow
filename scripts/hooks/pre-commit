#!/usr/bin/env bash

###############################################################################
# Pre-Commit Hook for Stage Framework Enforcement
#
# Blocks commits to stage-proofs/ unless:
# 1. Proof file has no placeholders (except [commit hash])
# 2. CHANGELOG.md was modified (if stage-proofs modified)
# 3. All mandatory gates have output files
#
# Installation:
#   cp scripts/hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or use the install script:
#   ./scripts/install-hooks.sh
#
###############################################################################

set -euo pipefail

# Colors (disable in non-interactive)
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m'
else
    RED=''
    GREEN=''
    YELLOW=''
    NC=''
fi

print_error() { echo -e "${RED}âŒ PRE-COMMIT BLOCKED: $1${NC}" >&2; }
print_warning() { echo -e "${YELLOW}âš ï¸  $1${NC}" >&2; }
print_success() { echo -e "${GREEN}âœ… $1${NC}"; }

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# Check if any stage-proofs files are being committed
STAGED_PROOFS=$(echo "$STAGED_FILES" | grep "^stage-proofs/" || true)

if [[ -z "$STAGED_PROOFS" ]]; then
    # No stage-proofs files, allow commit
    exit 0
fi

echo "ðŸ” Stage framework pre-commit checks..."

###############################################################################
# Extract stage number from staged files
###############################################################################
STAGE_NUM=$(echo "$STAGED_PROOFS" | head -1 | sed -n 's|stage-proofs/stage-\([^/]*\)/.*|\1|p')

if [[ -z "$STAGE_NUM" ]]; then
    # Can't determine stage number, allow commit
    exit 0
fi

STAGE_DIR="stage-proofs/stage-$STAGE_NUM"
PROOF_FILE="$STAGE_DIR/STAGE_${STAGE_NUM}_PROOF.md"

###############################################################################
# Check 1: Proof file has no placeholders
###############################################################################
if [[ -f "$PROOF_FILE" ]]; then
    # Count placeholders (excluding [commit hash] which is filled post-commit)
    PLACEHOLDERS=$(grep -c -E "\[(TBD|TODO|N/N|XX%|PLACEHOLDER)\]" "$PROOF_FILE" 2>/dev/null || echo "0")

    if [[ "$PLACEHOLDERS" -gt 0 ]]; then
        print_error "Proof file has $PLACEHOLDERS unfilled placeholders"
        echo ""
        echo "Placeholders found in $PROOF_FILE:"
        grep -n -E "\[(TBD|TODO|N/N|XX%|PLACEHOLDER)\]" "$PROOF_FILE" | head -10
        echo ""
        echo "Fix: Complete the proof file before committing."
        echo "     Replace all [TBD], [N/N], [XX%] with actual values."
        exit 1
    fi
fi

###############################################################################
# Check 2: CHANGELOG.md was modified
###############################################################################
if ! echo "$STAGED_FILES" | grep -q "^CHANGELOG.md$"; then
    print_error "CHANGELOG.md not included in commit"
    echo ""
    echo "When committing stage-proofs/, CHANGELOG.md must also be updated."
    echo ""
    echo "Fix: Add CHANGELOG entry for Stage $STAGE_NUM:"
    echo "     - Add entry with tests, coverage, deliverables"
    echo "     - git add CHANGELOG.md"
    exit 1
fi

###############################################################################
# Check 3: Mandatory gates have output files
###############################################################################
GATES_DIR="$STAGE_DIR/reports/gates"

if [[ -d "$GATES_DIR" ]]; then
    MANDATORY_GATES=(1 2 3 5 6 7 8)
    MISSING_GATES=()

    for gate in "${MANDATORY_GATES[@]}"; do
        if ! ls "$GATES_DIR"/gate-$gate-*.txt &>/dev/null; then
            MISSING_GATES+=("$gate")
        fi
    done

    if [[ ${#MISSING_GATES[@]} -gt 0 ]]; then
        print_warning "Missing gate outputs: ${MISSING_GATES[*]}"
        echo ""
        echo "Run quality gates before committing:"
        echo "  ./scripts/run-quality-gates.sh --stage $STAGE_NUM ${MISSING_GATES[*]}"
        echo ""
        echo "Continuing anyway (gates are checked at stage completion)..."
        # Note: This is a warning, not a block
    fi
fi

###############################################################################
# Check 4: State file exists
###############################################################################
STATE_FILE="$STAGE_DIR/.stage-state.yaml"

if [[ ! -f "$STATE_FILE" ]]; then
    print_warning "Stage state file not found: $STATE_FILE"
    echo "Consider using: ./scripts/init-stage.sh --stage $STAGE_NUM --name \"...\""
fi

###############################################################################
# All checks passed
###############################################################################
print_success "Pre-commit checks passed for Stage $STAGE_NUM"
exit 0
